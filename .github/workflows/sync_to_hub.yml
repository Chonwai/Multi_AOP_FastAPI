name: Sync to Hugging Face Hub (Production)
on:
  push:
    branches: [production]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true # 雖然我們不推 LFS，但保持開啟避免 checkout 報錯
          ref: production

      - name: Push to hub
        run: |
          git config --global user.email "alchemist.dev01@gmail.com"
          git config --global user.name "AlchemistAIDev01"
          
          # 1. 配置遠端
          git config --global --unset credential.helper || true
          git remote add space https://AlchemistAIDev01:${{ secrets.HF_ALCHEMISTAIDEV01 }}@huggingface.co/spaces/AlchemistAIDev01/Multi_AOP_FastAPI

          # 2. ⭐️ 魔法步驟：暴力移除歷史中的大文件
          # 這行命令會從當前分支的所有歷史記錄中，徹底刪除所有 .pth 和 .bin 文件
          # --cached 表示只刪除索引，不刪除工作目錄文件 (但在 CI 裡刪了也沒事)
          # --ignore-unmatch 避免文件不存在時報錯
          git filter-branch --force --index-filter "git rm --cached --ignore-unmatch *.pth *.bin *.onnx final_model/* predict/model/*" --prune-empty --tag-name-filter cat -- --all

          # 3. 推送 (使用 --force 是必須的，因為歷史被我們改寫了)
          git push --force space production:main
