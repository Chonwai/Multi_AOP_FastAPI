services:
  multi-aop-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: multi-aop-api
    ports:
      # Dynamic port mapping: host:container
      # Both use the same PORT value for consistency
      - "${PORT:-8000}:${PORT:-8000}"
    environment:
      # API Configuration
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      # PORT environment variable (used by Dockerfile CMD)
      # Default: 8000 (local), Render sets: 10000
      - PORT=${PORT:-8000}
      
      # CORS Configuration
      - CORS_ORIGINS=${CORS_ORIGINS:-["*"]}
      
      # Model Configuration
      - MODEL_PATH=${MODEL_PATH:-predict/model/best_model_Oct13.pth}
      - DEVICE=${DEVICE:-cpu}
      
      # Sequence Processing Configuration
      - SEQ_LENGTH=${SEQ_LENGTH:-50}
      - BATCH_SIZE=${BATCH_SIZE:-16}
      - MAX_BATCH_SIZE=${MAX_BATCH_SIZE:-100}
      
      # Logging Configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Environment
      - ENVIRONMENT=${ENVIRONMENT:-production}
    volumes:
      # Mount model directory (optional, if model is not in image)
      - ../predict/model:/app/predict/model:ro
      # Mount logs directory (optional)
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      # Dynamic health check using PORT environment variable
      test: ["CMD", "sh", "-c", "python -c \"import requests; requests.get('http://localhost:$${PORT:-8000}/health')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - multi-aop-network

networks:
  multi-aop-network:
    driver: bridge
